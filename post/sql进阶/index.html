  <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Sql进阶 &middot; Miao&amp;Blog </title>
    
    <link rel="stylesheet" type="text/css" href="https://charliemini.github.io/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="https://charliemini.github.io/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://charliemini.github.io/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="https://charliemini.github.io/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Miao&amp;Blog" />
    
    <script src="https://charliemini.github.io/js/jquery.min.js"></script>
    <script src="https://charliemini.github.io/js/main.min.js">
    </script>
</head>

  <body>
    <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/background-cover.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="https://charliemini.github.io/" title="link to homepage for Miao&amp;Blog"> <img src="https://charliemini.github.io/img/logo-1.jpg" width="80" alt="Miao&amp;Blog logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="https://charliemini.github.io/"  title="link to homepage for Miao&amp;Blog">Miao&amp;Blog</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  欢迎来到我的博客，下方有我的联系方式  </p>
                <hr class="panel-cover__divider panel-cover__divider--secondary" />
                <div class="navigation-wrapper">
                    <nav class="cover-navigation cover-navigation--primary">
                        <ul class="navigation">
                            <li class="navigation__item"><a href="https://charliemini.github.io#blog" title="link to Miao&amp;Blog blog" class="blog-button">Blog</a> </li></br>
                            
                            
                       </ul>
                    </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/wallflo61460582" title="@wallflo61460582 on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/charliemini" title="charliemini on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>   
        
        <li class="navigation__item">
            <a href="mailto:2314259324@qq.com" title="Email 2314259324@qq.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/background-cover.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="https://charliemini.github.io/" title="link to homepage for Miao&amp;Blog"> <img src="https://charliemini.github.io/img/logo-1.jpg" width="80" alt="Miao&amp;Blog logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="https://charliemini.github.io/"  title="link to homepage for Miao&amp;Blog">Miao&amp;Blog</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  欢迎来到我的博客，下方有我的联系方式  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="https://charliemini.github.io/#blog" title="link to Miao&amp;Blog blog" class="blog-button">Blog</a> </li></br>
                                
                                
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
        
        <li class="navigation__item">
            <a href="http://twitter.com/wallflo61460582" title="@wallflo61460582 on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
        </li>   
        
        <li class="navigation__item">
            <a href="https://github.com/charliemini" title="charliemini on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>   
        
        <li class="navigation__item">
            <a href="mailto:2314259324@qq.com" title="Email 2314259324@qq.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <div class="post">
          <h1>Sql进阶</h1>
          <span class="post-date">Tue, Aug 7, 2018</span>
          <h2 id="连接">连接</h2>

<p>数据库查询的连接可分为内连接，外链接，交叉连接。</p>

<ol>
<li>内连接 <code>table1 inner join table2 条件</code></li>
</ol>

<p>内连接查询的时候，只有条件真的满足的时候才会返回搜索结果，不会像外连接那样在不满足条件的情况下左表或右表 返回空值。</p>

<ol>
<li>外连接 <code>left join 条件</code>  <code>right join 条件</code> <code>outer jion 条件</code></li>
</ol>

<p>以左外连接为例，左外连接以左表为主，如果条件为能得到满足，会返回左表数据和空的“右表数据”。右外连接类似。</p>

<p>而全连接不以哪个表为主，只要是哪个表有数据就ok,以空值代替缺失。</p>

<ol>
<li>交叉连接 <code>cross join</code>&lsquo;</li>
</ol>

<p>交叉连接也被叫做笛卡尔积，类似于矩阵相乘，在没有条件的情况下，将左边的每一行与右表的每一行组合。</p>

<p><strong>注意</strong>： 数据库连表查询时，是通过生成临时表来返回数据。在外连接条件中，<code>on</code>关键字作用于生成临时表的时候，它是不管<code>on</code>的条件是否被满足，都会返回左表的数据。而<code>where</code>关键字是在临时表生成后，再对临时表进行过滤，所以不会刻意保留“主表”数据。</p>

<h2 id="判断">判断</h2>

<ol>
<li><code>if(true/false, a, b)</code></li>
</ol>

<p>如果真/假，执行a，否则执行b</p>

<p>Eg. <code>update tabke1 set status = if(status=true, false, true)</code></p>

<p>上面这条sql语句意为将status字段值为true的改为false，值不等于true的改为true。</p>

<ol>
<li><code>ifnull(a, b)</code></li>
</ol>

<p>从左往右判断，如果a不为null，就取a；如果a为null，就取b。</p>

<ol>
<li><code>case when then else end</code></li>
</ol>

<p>Eg. <code>select (case status when true then 1 when flase then 0 end) from table1</code></p>

<p>从table1表里查询status字段，并修改该字段返回值，true-&gt;1，false-&gt;0</p>

<h2 id="sql练习">sql练习</h2>

<p>​       可以在复制语句在 <a href="http://sqlfiddle.com/">sqlfiddle</a> 网站中练习</p>

<pre><code class="language-sql">存储过程，表名做参数
DELIMITER //
    CREATE PROCEDURE GetCount(name varchar(100))
    BEGIN
        set @sql_select = concat('SELECT count(1)  FROM ',name);
        prepare sql_select from @sql_select;
        execute sql_select;
    END //
DELIMITER ;
</code></pre>

<pre><code class="language-sql">查找每个学科分数都大于80的学生姓名

create table study(
  name varchar(30),
  subject varchar(50),
  score int
);

insert into study values
('张三',  '语文', 81),
('张三',  '数学', 75),
('李四',  '语文', 76),
('李四',  '数学', 90),
('王五',  '语文', 81),
('王五',  '数学', 100),
('王五',  '英语', 90);

SQL: select name from (select distinct(name) as name,min(score) as score from study group by name) as a where score &gt;=80; 
</code></pre>

<pre><code class="language-sql">去除除了id之外的重复值

create table study(
  id int,
  s_id int,
  name varchar(30),
  sub_id  varchar(10),
  sub_name varchar(50),
  score int
);

insert into study values
(1, 2005001, '张三', '0001', '数学', 69),
(2, 2005002, '李四', '0001', '数学', 89),
(3, 2005001, '张三', '0001', '数学', 69);

查找unique
SQL: select *  from study where id  in (select MIN(id)  from study group by s_id,name,sub_id,sub_name,score )
删除重复：
SQl1: delete  from study where id not in (select a.id from (select min(id) as id from study group by s_id,name,sub_id,sub_name,score ) as a)
Sql2: insert into temp(s_id,name,sub_id,sub_name,score)  select distinct s_id,name,sub_id,sub_name,score from study

</code></pre>

<pre><code class="language-sql">查找各个月份debitoccur比ID为101大的数据

create table study(
  accid int,
  occmonth int,
  debitoccur int
);

insert into study values
(101,  1, 81),
(102,  1, 75),
(103,  1, 96),
(101,  2, 90),
(102,  2, 81),
(103,  2, 100),
(101, 3, 89);

SQL: select * from study as a, (select occmonth, debitoccur from study where accid=101) as b
          where a.occmonth = b.occmonth and  a.debitoccur&gt; b.debitoccur;
</code></pre>

<pre><code class="language-sql">给查出的数据根据score是否大于等于60增加一个是否通过的字段

create table study(
  id int,
  name varchar(10),
  score int
);

insert into study values
(1, 'a', 23),
(2, 'c', 61),
(3, 'b', 86);

SQL: select name, score , (case when score &gt;= 60 then 'pass' else 'faliure' end) as judge  from study;
</code></pre>

<pre><code class="language-sql">create table Student(SId varchar(10),Sname varchar(10),Sage datetime,Ssex varchar(10));
insert into Student values('01' , '赵雷' , '1990-01-01' , '男');
insert into Student values('02' , '钱电' , '1990-12-21' , '男');
insert into Student values('03' , '孙风' , '1990-12-20' , '男');
insert into Student values('04' , '李云' , '1990-12-06' , '男');
insert into Student values('05' , '周梅' , '1991-12-01' , '女');
insert into Student values('06' , '吴兰' , '1992-01-01' , '女');
insert into Student values('07' , '郑竹' , '1989-01-01' , '女');
insert into Student values('09' , '张三' , '2017-12-20' , '女');
insert into Student values('10' , '李四' , '2017-12-25' , '女');
insert into Student values('11' , '李四' , '2012-06-06' , '女');
insert into Student values('12' , '赵六' , '2013-06-13' , '女');
insert into Student values('13' , '孙七' , '2014-06-01' , '女');

create table Course(CId varchar(10),Cname nvarchar(10),TId varchar(10));
insert into Course values('01' , '语文' , '02');
insert into Course values('02' , '数学' , '01');
insert into Course values('03' , '英语' , '03');

create table Teacher(TId varchar(10),Tname varchar(10));
insert into Teacher values('01' , '张三');
insert into Teacher values('02' , '李四');
insert into Teacher values('03' , '王五');

create table SC(SId varchar(10),CId varchar(10),score decimal(18,1));
insert into SC values('01' , '01' , 80);
insert into SC values('01' , '02' , 90);
insert into SC values('01' , '03' , 99);
insert into SC values('02' , '01' , 70);
insert into SC values('02' , '02' , 60);
insert into SC values('02' , '03' , 80);
insert into SC values('03' , '01' , 80);
insert into SC values('03' , '02' , 80);
insert into SC values('03' , '03' , 80);
insert into SC values('04' , '01' , 50);
insert into SC values('04' , '02' , 30);
insert into SC values('04' , '03' , 20);
insert into SC values('05' , '01' , 76);
insert into SC values('05' , '02' , 87);
insert into SC values('06' , '01' , 31);
insert into SC values('06' , '03' , 34);
insert into SC values('07' , '02' , 89);
insert into SC values('07' , '03' , 98);

1. 查询&quot; 01 &quot;课程比&quot; 02 &quot;课程成绩高的学生的信息及课程分数
SQL:select Sname,score from Student, 
(select a.SId as id, a.score as score   from SC as a, SC as b where a.SId=b.SId and a.CId ='01' and b.CId='02' and a.score&gt;b.score) as c 
where Student.SId=c.id;  

1.1 查询同时存在&quot; 01 &quot;课程和&quot; 02 &quot;课程的情况
SQL:select * from SC as a, SC as b where a.SId = b.SId and a.CId='01' and b.CId='02'

1.2 查询存在&quot; 01 &quot;课程但可能不存在&quot; 02 &quot;课程的情况(不存在时显示为 null )
SQL: select * from
  (select * from SC where SC.CId='01') as a left join
  (select * from SC where SC.CId='02') as b
  on a.SId=b.SId;

1.3 查询不存在&quot; 01 &quot;课程但存在&quot; 02 &quot;课程的情况
SQL: select * from SC where CId='02' and SId not in (select distinct(SId) as id from SC where CId='01') ;

2. 查询平均成绩大于等于 60 分的同学的学生编号和学生姓名和平均成绩
SQL: select a.SId, a.ascore, Student.Sname from (select SId, avg(score) as ascore from SC group by SId having ascore &gt;=60) as a inner
join Student on a.SId = Student.SId ;

3. 查询在 SC 表存在成绩的学生信息
SQl1: select * from Student where SId in (select distinct(SId) from SC );
SQL2: select * from Student where  exists (select SId from SC where SId=Student.SId);

4. 查询所有同学的学生编号、学生姓名、选课总数、所有课程的总成绩(没成绩的显示为 null )
SQL: select a.SId,  a.Sname, b.Sscore, b.Scount  from Student as a left join 
(select SId, sum(score) as Sscore,count(SId) as Scount from SC group by SId) as b
on a.SId=b.SId;

5. 查询「李」姓老师的数量
SQL: select count(*) from Teacher where Tname like '李%';

6. 查询学过「张三」老师授课的同学的信息
SQL1: select * from Student inner join 
  (select SId from SC,
    (select CId  from Course, Teacher where Tname='张三' and Teacher.TId = Course.TId) as a 
   where SC.CId= a.CId) as b on Student.SId = b.SId ;
SQL2: select * from Student, SC, Course,Teacher 
  where Teacher.Tname='张三' and
  Course.TId = Teacher.TId and
  SC.CId = Course.CId and 
  Student.SId = SC.SId;

7. 查询没有学全所有课程的同学的信息
SQL: select Student.* from Student,
(select SId, count(distinct CId) as Scount from SC group by SId) as a
 where a.Scount &lt;(select count(distinct CId)  from Course) and  Student.SId=a.SId;

8. 查询至少有一门课与学号为&quot; 01 &quot;的同学所学相同的同学的信息
SQL: select Student.* from Student,
  (select distinct SId from SC where SId != '01' and CId in (select CId from SC where SID='01')) as a
  where Student.SId=a.SId;

9. 查询和&quot; 01 &quot;号的同学学习的课程完全相同的其他同学的信息
SQL: select Student.* from Student ,(select SId, group_concat(CId order by CId) as Cconcat from SC group by SId ) as a  where 
a.SId != '01' and  Cconcat = (select group_concat(CId order by CId) as Cconcat from SC group by SId  having SId ='01') 
and Student.SId =a.SId;

10. 查询没学过&quot;张三&quot;老师讲授的任一门课程的学生姓名
SQL1: select  SId,Sname from Student where SId not in
  (select distinct Sid from SC where  SId  in 
    (select  SId from Course,Teacher,SC where Tname='张三' and Teacher.TId = Course.TId and SC.CId =Course.CId)) ;
SQL2: select  SId,Sname from Student where not exists
(select SId from
  (select distinct Sid from SC where  SId  in 
    (select  SId from Course,Teacher,SC where Tname='张三' and Teacher.TId = Course.TId and SC.CId =Course.CId))
   as a  where SId =Student.SId) ;

11. 查询两门及其以上不及格课程的同学的学号，姓名及其平均成绩
SQL: select Student.SId, Sname, ascore from Student,
(select SId  from (select SId, score from SC where score&lt;60) as a group by SId having count(SId)&gt;1) as a,
(select SId, avg(score) as ascore from SC group by SId) as b
where Student.SId=a.SId and Student.SId=b.SId;

12. 检索&quot; 01 &quot;课程分数小于 60，按分数降序排列的学生信息
SQL: select Student.*, SC.score from Student inner join
SC on Student.SId = SC.SId and SC.CId='01' and SC.score&lt;60 order by SC.score desc;

</code></pre>
        </div>
        <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=Sql%e8%bf%9b%e9%98%b6-https%3a%2f%2fcharliemini.github.io%2fpost%2fsql%25E8%25BF%259B%25E9%2598%25B6%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-3x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fcharliemini.github.io%2fpost%2fsql%25E8%25BF%259B%25E9%2598%25B6%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-3x"></span></a>
<a href="https://plus.google.com/share?url=https%3a%2f%2fcharliemini.github.io%2fpost%2fsql%25E8%25BF%259B%25E9%2598%25B6%2f" target="_blank" title="Google+" class="googleplus">
<span class="fa fa-google-plus-square fa-3x"></span></a>
<a href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fcharliemini.github.io%2fpost%2fsql%25E8%25BF%259B%25E9%2598%25B6%2f&title=Sql%e8%bf%9b%e9%98%b6" target="_blank" title="LinkedIn" class="linkedin">
<span class="fa fa-linkedin-square fa-3x"></span></a>
<a href="http://www.reddit.com/submit?url=https%3a%2f%2fcharliemini.github.io%2fpost%2fsql%25E8%25BF%259B%25E9%2598%25B6%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-3x"></span></a>
<a href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fcharliemini.github.io%2fpost%2fsql%25E8%25BF%259B%25E9%2598%25B6%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="fa fa-stumbleupon fa-3x">
</span></a>
</div>
        



      </div>
    </div>

  </body>
  
</html>
